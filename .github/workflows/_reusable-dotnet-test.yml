# Reusable workflow for .NET testing with coverage
# Generalized from dotnet-test-grid.yml to work across sub-repos

name: Reusable .NET Test

on:
  workflow_dispatch:
    inputs:
      test-projects:
        description: 'Glob pattern or space-separated list of test project paths'
        required: true
        type: string
      dotnet-version:
        description: '.NET SDK version'
        required: false
        type: string
        default: '10.0.x'
      configuration:
        description: 'Build configuration'
        required: false
        type: choice
        options:
          - Release
          - Debug
        default: 'Release'
      coverage-threshold:
        description: 'Minimum coverage percentage (0 to disable)'
        required: false
        type: number
        default: 60
      include-maui:
        description: 'Install MAUI workloads'
        required: false
        type: boolean
        default: false
      test-filter:
        description: 'Optional test filter expression'
        required: false
        type: string
        default: ''
      runsettings-path:
        description: 'Path to coverlet .runsettings file'
        required: false
        type: string
        default: ''
      build-projects:
        description: 'Space-separated list of source projects to build before testing (avoids TreatWarningsAsErrors on test projects)'
        required: false
        type: string
        default: ''
      job-identifier:
        description: 'Unique identifier for this job invocation (used in artifact names)'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      test-projects:
        description: 'Glob pattern or space-separated list of test project paths'
        required: true
        type: string
      dotnet-version:
        description: '.NET SDK version'
        required: false
        type: string
        default: '10.0.x'
      configuration:
        description: 'Build configuration'
        required: false
        type: string
        default: 'Release'
      coverage-threshold:
        description: 'Minimum coverage percentage (0 to disable)'
        required: false
        type: number
        default: 60
      include-maui:
        description: 'Install MAUI workloads'
        required: false
        type: boolean
        default: false
      test-filter:
        description: 'Optional test filter expression'
        required: false
        type: string
        default: ''
      runsettings-path:
        description: 'Path to coverlet .runsettings file'
        required: false
        type: string
        default: ''
      build-projects:
        description: 'Space-separated list of source projects to build before testing (avoids TreatWarningsAsErrors on test projects)'
        required: false
        type: string
        default: ''
      job-identifier:
        description: 'Unique identifier for this job invocation (used in artifact names)'
        required: false
        type: string
        default: ''
    outputs:
      coverage-percentage:
        description: 'Code coverage percentage'
        value: ${{ jobs.test-coverage.outputs.coverage_percentage }}
      tests-passed:
        description: 'Number of tests passed'
        value: ${{ jobs.run-tests.outputs.passed }}
      tests-failed:
        description: 'Number of tests failed'
        value: ${{ jobs.run-tests.outputs.failed }}

permissions:
  contents: read
  checks: write

jobs:
  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    outputs:
      passed: ${{ steps.test-results.outputs.passed }}
      failed: ${{ steps.test-results.outputs.failed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11  # v4.1.1
        with:
          repository: ${{ github.repository }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@4d6c8fcf3c8f7a60068d26b594648e99df24cee3  # v4.0.0
        with:
          dotnet-version: ${{ inputs.dotnet-version }}

      - name: Install MAUI workloads
        if: inputs.include-maui
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 15
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            dotnet workload install maui-android maui-tizen --skip-sign-check --verbosity detailed
            dotnet workload list

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-test-${{ hashFiles('**/*.csproj', '**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-test-
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 10
          max_attempts: 3
          retry_wait_seconds: 30
          command: |
            if [ -n "${{ inputs.build-projects }}" ]; then
              echo "Restoring build projects..."
              for project in ${{ inputs.build-projects }}; do
                echo "Restoring: $project"
                dotnet restore "$project"
              done
            fi
            if [ -n "${{ inputs.test-projects }}" ]; then
              echo "Restoring test projects..."
              for project in ${{ inputs.test-projects }}; do
                echo "Restoring: $project"
                dotnet restore "$project"
              done
            fi
            if [ -z "${{ inputs.build-projects }}" ] && [ -z "${{ inputs.test-projects }}" ]; then
              echo "Restoring all projects..."
              dotnet restore
            fi

      - name: Build source projects
        if: inputs.build-projects != ''
        run: |
          for project in ${{ inputs.build-projects }}; do
            echo "Building: $project"
            dotnet build --configuration ${{ inputs.configuration }} --no-restore "$project"
          done
        timeout-minutes: 15

      - name: Run tests
        id: run-tests
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 15
          max_attempts: 2
          retry_wait_seconds: 10
          command: |
            TEST_ARGS="--configuration ${{ inputs.configuration }} --verbosity normal"
            TEST_ARGS="$TEST_ARGS --collect:\"XPlat Code Coverage\""
            TEST_ARGS="$TEST_ARGS --results-directory ./TestResults"
            TEST_ARGS="$TEST_ARGS --logger \"trx;LogFileName=test-results.trx\""

            if [ -n "${{ inputs.test-filter }}" ]; then
              TEST_ARGS="$TEST_ARGS --filter \"${{ inputs.test-filter }}\""
            fi

            if [ -n "${{ inputs.runsettings-path }}" ]; then
              TEST_ARGS="$TEST_ARGS --settings ${{ inputs.runsettings-path }}"
            fi

            # Run tests for each project matching the pattern
            for project in ${{ inputs.test-projects }}; do
              if [ -f "$project" ]; then
                echo "Testing: $project"
                eval dotnet test $TEST_ARGS "$project"
              fi
            done

      - name: Parse test results
        id: test-results
        if: always()
        run: |
          TRX_FILE=$(find TestResults -name "*.trx" -type f 2>/dev/null | head -1)
          if [ -f "$TRX_FILE" ]; then
            PASSED=$(grep -oP 'Counters[^>]*passed="\K[0-9]+' "$TRX_FILE" | head -1 || echo "0")
            FAILED=$(grep -oP 'Counters[^>]*failed="\K[0-9]+' "$TRX_FILE" | head -1 || echo "0")
            echo "passed=${PASSED:-0}" >> $GITHUB_OUTPUT
            echo "failed=${FAILED:-0}" >> $GITHUB_OUTPUT
            echo "Passed=$PASSED, Failed=$FAILED"
          else
            echo "passed=0" >> $GITHUB_OUTPUT
            echo "failed=0" >> $GITHUB_OUTPUT
            echo "No TRX file found"
          fi

      - name: Upload test results
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        if: always()
        with:
          name: test-results-${{ inputs.job-identifier != '' && format('{0}-', inputs.job-identifier) || '' }}${{ github.run_id }}-${{ github.run_attempt }}
          path: TestResults/*.trx
          retention-days: 30

      - name: Upload coverage results
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        if: always()
        with:
          name: coverage-data-${{ inputs.job-identifier != '' && format('{0}-', inputs.job-identifier) || '' }}${{ github.run_id }}-${{ github.run_attempt }}
          path: TestResults/*/coverage.cobertura.xml
          retention-days: 30

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@30eadd5010312f995f0d3b3cff7fe2984f69409e  # v2.16.1
        if: always()
        with:
          files: TestResults/**/*.trx
          check_name: Unit Tests
          comment_mode: off

  test-coverage:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [run-tests]
    if: always()
    timeout-minutes: 15

    outputs:
      coverage_percentage: ${{ steps.parse-coverage.outputs.coverage }}

    steps:
      - name: Download coverage artifacts
        uses: actions/download-artifact@87c55149d96e628cc2ef7e6fc2aab372015aec85  # v4.1.8
        with:
          name: coverage-data-${{ inputs.job-identifier != '' && format('{0}-', inputs.job-identifier) || '' }}${{ github.run_id }}-${{ github.run_attempt }}
          path: TestResults

      - name: Install ReportGenerator
        uses: nick-fields/retry@7152eba30c6575329ac0576536151aca5a72780e  # v3.0.0
        with:
          timeout_minutes: 5
          max_attempts: 3
          retry_wait_seconds: 10
          command: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Generate coverage report
        run: |
          export PATH="$PATH:$HOME/.dotnet/tools"
          REPORTS=$(find TestResults -name "coverage.cobertura.xml" 2>/dev/null | tr '\n' ';')
          if [ -n "$REPORTS" ]; then
            reportgenerator \
              -reports:"$REPORTS" \
              -targetdir:"CoverageReport" \
              -reporttypes:"Html;MarkdownSummaryGithub;Cobertura;Badges" \
              -assemblyfilters:"+Ouroboros.*"
          else
            echo "No coverage files found"
            mkdir -p CoverageReport
          fi

      - name: Parse coverage percentage
        id: parse-coverage
        if: always()
        run: |
          if [ -f "CoverageReport/SummaryGithub.md" ]; then
            COVERAGE=$(grep -oP '(?:Line coverage:|Lines:)\s*\K[0-9.]+(?=%)?' CoverageReport/SummaryGithub.md | head -1 || echo "0")
            if [ -z "$COVERAGE" ] || [ "$COVERAGE" = "0" ]; then
              COVERAGE=$(sed -n 's/.*Lines\?.*\([0-9][0-9]*\.[0-9][0-9]*\)%.*/\1/p' CoverageReport/SummaryGithub.md | head -1 || echo "0")
            fi
            echo "coverage=${COVERAGE:-0}" >> $GITHUB_OUTPUT
            echo "Coverage: ${COVERAGE}%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "No coverage report found"
          fi

      - name: Check coverage threshold
        if: inputs.coverage-threshold > 0
        run: |
          COVERAGE="${{ steps.parse-coverage.outputs.coverage }}"
          THRESHOLD="${{ inputs.coverage-threshold }}"
          if [ -n "$COVERAGE" ] && [ "$COVERAGE" != "0" ]; then
            COVERAGE_INT=$(echo "$COVERAGE" | cut -d. -f1)
            if [ "$COVERAGE_INT" -lt "$THRESHOLD" ]; then
              echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
            fi
          fi

      - name: Display coverage summary
        if: always()
        run: |
          if [ -f "CoverageReport/SummaryGithub.md" ]; then
            echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
            cat CoverageReport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@5d5d22a31266ced268874388b861e4b58bb5c2f3  # v4.3.1
        if: always()
        with:
          name: coverage-report-${{ inputs.job-identifier != '' && format('{0}-', inputs.job-identifier) || '' }}${{ github.run_id }}-${{ github.run_attempt }}
          path: CoverageReport/
          retention-days: 30
